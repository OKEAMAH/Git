# This file was automatically generated, do not edit.
# Edit file ci/bin/main.ml instead.
workflow:
  name: '[$PIPELINE_TYPE] $CI_COMMIT_TITLE'
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "merge_request_event"
    variables:
      PIPELINE_TYPE: before_merging
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "latest-release"
    variables:
      PIPELINE_TYPE: latest_release
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "latest-release-test"
    variables:
      PIPELINE_TYPE: test_latest_release
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master"
    variables:
      PIPELINE_TYPE: master_branch
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^vd+.d+(?:-rcd+)?$/
    variables:
      PIPELINE_TYPE: release_tag
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^vd+.d+-betad*$/
    variables:
      PIPELINE_TYPE: beta_release_tag
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^vd+.d+(?:-(rc|beta)d*)?$/
    variables:
      PIPELINE_TYPE: release_tag_test
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /^vd+.d+(?:-(rc|beta)d*)?$/
    variables:
      PIPELINE_TYPE: non_release_tag
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /^vd+.d+(?:-(rc|beta)d*)?$/
    variables:
      PIPELINE_TYPE: test_non_release_tag
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_TESTS"
    variables:
      PIPELINE_TYPE: scheduled_extended_test
default:
  interruptible: true
variables:
  build_deps_image_version: f84b4412bf92f81fa4d554aed624fa0a6a72ec96
  build_deps_image_name: ${CI_REGISTRY}/tezos/opam-repository
  GIT_STRATEGY: fetch
  GIT_DEPTH: "1"
  GET_SOURCES_ATTEMPTS: "2"
  ARTIFACT_DOWNLOAD_ATTEMPTS: "2"
  OPAMRETRIES: "5"
  FF_USE_FASTZIP: "true"
  RUNTEZTALIAS: "false"
stages:
- trigger
- sanity
- build
- test
- test_coverage
- packaging
- doc
- prepare_release
- publish_release_gitlab
- publish_release
- publish_package_gitlab
- manual
trigger:
  image: alpine:3.17
  stage: trigger
  tags:
  - gcp
  rules:
  - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_ASSIGNEES
      !~ /nomadic-margebot/
    when: manual
  -
  allow_failure: false
  timeout: 10 minutes
  script:
  - echo 'Trigger pipeline!'
  - ./scripts/ci/check_alpine_version.sh
include:
- .gitlab/ci/jobs/shared/images.yml
- .gitlab/ci/jobs/shared/templates.yml
- local: .gitlab/ci/pipelines/before_merging.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "merge_request_event"
- local: .gitlab/ci/pipelines/latest_release.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "latest-release"
- local: .gitlab/ci/pipelines/test_latest_release.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "latest-release-test"
- local: .gitlab/ci/pipelines/master_branch.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "master"
- local: .gitlab/ci/pipelines/release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^vd+.d+(?:-rcd+)?$/
- local: .gitlab/ci/pipelines/beta_release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^vd+.d+-betad*$/
- local: .gitlab/ci/pipelines/release_tag_test.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG =~ /^vd+.d+(?:-(rc|beta)d*)?$/
- local: .gitlab/ci/pipelines/non_release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE == "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /^vd+.d+(?:-(rc|beta)d*)?$/
- local: .gitlab/ci/pipelines/test_non_release_tag.yml
  rules:
  - if: $CI_PROJECT_NAMESPACE != "tezos" && $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_TAG != null && $CI_COMMIT_TAG !~ /^vd+.d+(?:-(rc|beta)d*)?$/
- local: .gitlab/ci/pipelines/scheduled_extended_test.yml
  rules:
  - if: $CI_PIPELINE_SOURCE == "schedule" && $TZ_SCHEDULE_KIND == "EXTENDED_TESTS"
