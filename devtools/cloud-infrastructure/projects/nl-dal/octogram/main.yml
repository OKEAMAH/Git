octogram_binary:
  push: octogram

agents:
  - name: node
    address: 127.0.0.1
    user: root
    port: 30000
    identity: ~/.ssh/tf

vars:
  network: sandbox
  
stages:
  - name: Running nodes
    with_agents: 'node'
    run_agents: concurrent
    jobs:
      - name: Upload octez-node
        copy:
          local_path: octez-node
          remote_path: '.'

      - name: Upload octez-client
        copy:
          local_path: octez-client
          remote_path: '.'

      - name: Upload protocol file
        copy:
          local_path: 'src/proto_alpha/parameters/sandbox-parameters.json'
          remote_path: '.'
          
      - name: Start octez-node
        tezos.start_node:
          name: node
          path_node: self://./octez-node
          network: '{{ vars.network }}'
          synchronization_threshold: 0
          rpc_port: '30001'
          metrics_port: '30002'
          net_port: '30003'
          
      - name: Activate protocol
        tezos.activate_protocol:
          endpoint: self://node
          path_client: self://./octez-client
          protocol: alpha
          
      - name: Wait for bootstrapped node
        tezos.wait_for_bootstrapped:
          path_client: self://./octez-client
          endpoint: self://node
      
