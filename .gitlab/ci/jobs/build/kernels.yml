build_kernels:
  extends:
    - .tags_template__build
    - .kernels_template
  stage: build
  needs: [trigger]
  script:
    - ./.gitlab/ci/jobs/build/kernels.sh
  artifacts:
    name: "build-kernels-$CI_COMMIT_REF_SLUG"
    paths:
      - evm_kernel.wasm
      - smart-rollup-installer
      - sequenced_kernel.wasm
      - tx_kernel.wasm
      - tx_kernel_dal.wasm
      - dal_echo_kernel.wasm
      - risc-v-sandbox
      - risc-v-dummy.elf
      - src/risc_v/tests/inline_asm/rv64-inline-asm-tests
    expire_in: 1 day
    when: on_success
  cache:
  cache:
    - key: kernels
      paths:
        - cargo/
    - key: "flake-test-cache-$CI_JOB_NAME-$CI_COMMIT_SHORT_SHA"
      paths:
        - evm_kernel.wasm
        - smart-rollup-installer
        - sequenced_kernel.wasm
        - tx_kernel.wasm
        - tx_kernel_dal.wasm
        - dal_echo_kernel.wasm
        - risc-v-sandbox
        - risc-v-dummy.elf
        - src/risc_v/tests/inline_asm/rv64-inline-asm-tests
