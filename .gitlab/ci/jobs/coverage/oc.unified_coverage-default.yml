# This file was automatically generated, do not edit.
# Edit file ci/bin/main.ml instead.

oc.unified_coverage:
  image: ${build_deps_image_name}:runtime-build-test-dependencies--${build_deps_image_version}
  stage: test_coverage
  tags:
  - gcp
  dependencies: []
  allow_failure: true
  script:
  - . ./scripts/version.sh
  - mkdir -p _coverage_report
  - dune exec scripts/ci/download_coverage/download.exe -- -a from=last-merged-pipeline
    --info --log-file _coverage_report/download_coverage.log
  - ./scripts/ci/report_coverage.sh
  variables:
    PROJECT: $CI_PROJECT_PATH
    DEFAULT_BRANCH: $CI_COMMIT_SHA
    COVERAGE_OPTIONS: --instrument-with bisect_ppx
    BISECT_FILE: $CI_PROJECT_DIR/_coverage_output/
    SLACK_COVERAGE_CHANNEL: C02PHBE7W73
  artifacts:
    expire_in: 15 days
    paths:
    - _coverage_report/
    - $BISECT_FILE
    reports:
      coverage_report:
        coverage_format: cobertura
        path: _coverage_report/cobertura.xml
    when: always
    expose_as: Coverage report
  coverage: '/Coverage: ([^%]+%)/'
