---
# This job fetches coverage files by precedent test stage. It creates the html,
# summary and cobertura reports. It also provide a coverage % for the merge request.

include: .gitlab/ci/jobs/coverage/common.yml

unified_coverage:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_test_dependencies_template
    - .template__coverage_report
  rules:
    # We do not run this job when margebot triggers the
    # pipeline. Instead, the coverage traces are downloaded in the
    # master pipeline and the report is computed there.
    - if: '$GITLAB_USER_LOGIN == "nomadic-margebot"'
      when: never
    - when: on_success
  # This job requires all bisect_ppx artifacts from the stage test, so we override
  # the `dependencies: []` in `.default_settings` with a list of jobs.
  # Each new job in the stage test needs to be manually added to this list.
  # /!\ Warning: this list is read by `scripts/ci/download_coverage/download.ml`.
  # The 'dependencies' field must be followed directly by the 'script' field.
  dependencies:
    - "tezt 1/2"
    - "tezt 2/2"
  before_script:
    - opam remote add default https://opam.ocaml.org --rank=-1
    - opam pin https://github.com/maxim092001/bisect_ppx.git#master --yes
  script:
    # On the development branches, we compute coverage
    - ./scripts/ci/report_coverage.sh
