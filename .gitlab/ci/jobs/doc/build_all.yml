# Warning: the documentation:linkcheck job must have at least the same
# restrictions in the rules as documentation:build_all, otherwise the CI
# may complain that documentation:linkcheck depends on documentation:build_all
# which does not exist.
documentation:build_all:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_test_dependencies_template
    - .tags_template__build
  stage: build
  needs: [trigger]
  variables:
    DUNE_CACHE: "enabled"
    XDG_CACHE_HOME: $CI_PROJECT_DIR/_build/_dune_cache
    DUNE_CACHE_STORAGE_MODE: "hardlink"
  cache:
    key: $CI_JOB_NAME_SLUG
    paths:
      - _build/_dune_cache
  before_script:
    - . $HOME/.venv/bin/activate
    - env | grep CACHE
    ### Inspect size and contents of Dune cache
    - '[ -d $XDG_CACHE_HOME ] && { du -hs $XDG_CACHE_HOME; find $XDG_CACHE_HOME/dune/db/ -type f | wc -l ; } || true'
  script:
    - ./.gitlab/ci/jobs/doc/documentation:build_all.sh
  after_script:
    ### Inspect size and contents of Dune cache
    - '[ -d $XDG_CACHE_HOME ] && { du -hs $XDG_CACHE_HOME; find $XDG_CACHE_HOME/dune/db/ -type f | wc -l ; } || true'
  artifacts:
    expose_as: 'Documentation - excluding old protocols'
    paths:
      # Path must be terminated with / to expose artifact (gitlab-org/gitlab#/36706)
      - docs/_build/
    expire_in: 1 week
