# check that ksy files are still up-to-date with octez
kaitai_checks:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_dependencies
  stage: test
  needs:
    - "oc.build_x86_64-released"
  rules:
    - changes:
        paths:
          - src/**/*
          - contrib/*kaitai*/**/*
          - .gitlab/**/*
          - .gitlab-ci.yml
      when: on_success
  before_script:
    - . ./scripts/version.sh
    - eval $(opam env)
  script:
    - make -C ${CI_PROJECT_DIR} check-kaitai-struct-files || (echo 'Octez encodings and Kaitai files seem to be out of sync. You might need to run `make check-kaitai-struct-files` and commit the resulting diff.' ; false)
