# This file was automatically generated, do not edit.
# Edit file ci/bin/main.ml instead.

tezt:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp_tezt
  rules:
  - changes:
    - src/**/*
    - etherlink/**/*
    - tezt/**/*
    - .gitlab/**/*
    - .gitlab-ci.yml
    - michelson_test_scripts/**/*
    - tzt_reference_test_suite/**/*
    when: on_success
  needs:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  dependencies:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  before_script:
  - . ./scripts/version.sh
  - eval $(opam env)
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/exit_code.sh _build/default/tezt/tests/main.exe
    ${TESTS} --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800
    --on-unknown-regression-files fail --junit ${JUNIT} --from-record tezt/records
    --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1} --record tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    --job-count ${TEZT_PARALLEL:-3} --retry ${TEZT_RETRY:-1}
  - ./scripts/ci/merge_coverage.sh
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: ""
    TESTS: /ci_disabled /flaky /memory_3k /memory_4k /time_sensitive
    TEZT_RETRY: "1"
    TEZT_PARALLEL: "3"
    BISECT_FILE: $CI_PROJECT_DIR/_coverage_output/
  artifacts:
    name: coverage-files-$CI_JOB_ID
    expire_in: 3 days
    paths:
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    - $JUNIT
    - $BISECT_FILE
    reports:
      junit: $JUNIT
    when: always
  retry: 2
  parallel: 60
tezt-memory-4k:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp_tezt
  rules:
  - changes:
    - src/**/*
    - etherlink/**/*
    - tezt/**/*
    - .gitlab/**/*
    - .gitlab-ci.yml
    - michelson_test_scripts/**/*
    - tzt_reference_test_suite/**/*
    when: on_success
  needs:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  dependencies:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  before_script:
  - . ./scripts/version.sh
  - eval $(opam env)
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/exit_code.sh _build/default/tezt/tests/main.exe
    ${TESTS} --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800
    --on-unknown-regression-files fail --junit ${JUNIT} --from-record tezt/records
    --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1} --record tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    --job-count ${TEZT_PARALLEL:-3} --retry ${TEZT_RETRY:-1}
  - ./scripts/ci/merge_coverage.sh
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: -memory_4k
    TESTS: memory_4k
    TEZT_RETRY: "1"
    TEZT_PARALLEL: "1"
    BISECT_FILE: $CI_PROJECT_DIR/_coverage_output/
  artifacts:
    name: coverage-files-$CI_JOB_ID
    expire_in: 3 days
    paths:
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    - $JUNIT
    - $BISECT_FILE
    reports:
      junit: $JUNIT
    when: always
  retry: 2
  parallel: 4
tezt-memory-3k:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp_tezt
  rules:
  - changes:
    - src/**/*
    - etherlink/**/*
    - tezt/**/*
    - .gitlab/**/*
    - .gitlab-ci.yml
    - michelson_test_scripts/**/*
    - tzt_reference_test_suite/**/*
    when: on_success
  needs:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  dependencies:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  before_script:
  - . ./scripts/version.sh
  - eval $(opam env)
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/exit_code.sh _build/default/tezt/tests/main.exe
    ${TESTS} --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800
    --on-unknown-regression-files fail --junit ${JUNIT} --from-record tezt/records
    --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1} --record tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    --job-count ${TEZT_PARALLEL:-3} --retry ${TEZT_RETRY:-1}
  - ./scripts/ci/merge_coverage.sh
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: -memory_3k
    TESTS: memory_3k
    TEZT_RETRY: "1"
    TEZT_PARALLEL: "1"
    BISECT_FILE: $CI_PROJECT_DIR/_coverage_output/
  artifacts:
    name: coverage-files-$CI_JOB_ID
    expire_in: 3 days
    paths:
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    - $JUNIT
    - $BISECT_FILE
    reports:
      junit: $JUNIT
    when: always
  retry: 2
tezt-time-sensitive:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp_tezt
  needs:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  dependencies:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  before_script:
  - . ./scripts/version.sh
  - eval $(opam env)
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/exit_code.sh _build/default/tezt/tests/main.exe
    ${TESTS} --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800
    --on-unknown-regression-files fail --junit ${JUNIT} --from-record tezt/records
    --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1} --record tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    --job-count ${TEZT_PARALLEL:-3} --retry ${TEZT_RETRY:-1}
  - ./scripts/ci/merge_coverage.sh
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: -time_sensitive
    TESTS: time_sensitive
    TEZT_RETRY: "1"
    TEZT_PARALLEL: "1"
    BISECT_FILE: $CI_PROJECT_DIR/_coverage_output/
  artifacts:
    name: coverage-files-$CI_JOB_ID
    expire_in: 3 days
    paths:
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    - $JUNIT
    - $BISECT_FILE
    reports:
      junit: $JUNIT
    when: always
  retry: 2
tezt:static-binaries:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp
  rules:
  - changes:
    - src/**/*
    - etherlink/**/*
    - tezt/**/*
    - .gitlab/**/*
    - .gitlab-ci.yml
    - michelson_test_scripts/**/*
    - tzt_reference_test_suite/**/*
    when: on_success
  needs:
  - oc.build_x86_64-exp-dev-extra
  - oc.build:static-x86_64-linux-binaries
  - oc.tezt:fetch-records
  dependencies:
  - oc.build_x86_64-exp-dev-extra
  - oc.build:static-x86_64-linux-binaries
  - oc.tezt:fetch-records
  before_script:
  - mv octez-binaries/x86_64/octez-* .
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/exit_code.sh _build/default/tezt/tests/main.exe
    ${TESTS} --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800
    --on-unknown-regression-files fail --junit ${JUNIT} --from-record tezt/records
    --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1} --record tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    --job-count ${TEZT_PARALLEL:-3} --retry ${TEZT_RETRY:-1}
  - ./scripts/ci/merge_coverage.sh
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: ""
    TESTS: cli
    TEZT_RETRY: "1"
    TEZT_PARALLEL: "3"
  artifacts:
    name: coverage-files-$CI_JOB_ID
    expire_in: 3 days
    paths:
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    - $JUNIT
    reports:
      junit: $JUNIT
    when: always
