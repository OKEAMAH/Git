test_kernels:
  extends:
    - .oc.kernels_template
  stage: test
  dependencies: [oc.docker:rust-toolchain]
  needs: [oc.docker:rust-toolchain]
  script:
    - make -f kernels.mk check
    - make -f kernels.mk test
  rules:
    - changes:
        - .gitlab-ci.yml
        # Run if the `rust-toolchain` image is updated
        - images/**/*
        - kernels.mk
        - src/kernel_*/**/*
        - src/risc_v/**/*
        - etherlink/kernel_evm/**/*
        - .gitlab/**/*
        - .gitlab-ci.yml
  cache:
    - key: kernels
      paths:
        - cargo/
