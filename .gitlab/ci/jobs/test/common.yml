.template__code_quality:
  variables:
    CODE_QUALITY_REPORT: "_reports/gl-code-quality-report.json"

.test_template:
  extends:
    - .default_settings_template
    - .image_template__runtime_build_test_dependencies_template
    - .template__coverage
  stage: test
  before_script:
    - . ./scripts/version.sh
  retry: 2

# Merge coverage files after the execution
.template__coverage_files:
  extends: .template__coverage
  artifacts:
    name: "coverage-files-$CI_JOB_ID"
    paths:
      - $BISECT_FILE
    expire_in: 1 day
    when: on_success

# Definition for the environment to run all integration tests.
# This is also used by Tezt tests.
# In general we do not have to run make, which takes a while,
# because the binaries have been produced by the build job and are
# in the cache. But if they are not, we need to build them.
# Ideally we should also check that the baker / accuser / endorser
# exist (some tests use them) but their actual name depend on the protocol.
.integration_template:
  extends:
    - .test_template
    - .image_template__runtime_build_e2etest_dependencies_template
    - .template__coverage_files
  dependencies:
    - "build_x86_64-released"
    - "build_x86_64-exp-dev-extra"
    - "tezt:fetch-records"
  # Start immediately after 'build_x86_64' and don't wait for
  # intermediate stages to succeed
  needs:
    - "build_x86_64-released"
    - "build_x86_64-exp-dev-extra"
    - "tezt:fetch-records"


.unit_test_template:
  extends: .test_template
  variables:
    ARCH: ""
    MAKE_TARGETS: ""
  script:
    - make $MAKE_TARGETS
  artifacts:
    name: "$CI_JOB_NAME-$CI_COMMIT_SHA-${ARCH}"
    paths:
      - test_results
    reports:
      junit: test_results/*.xml
    expire_in: 1 day
    when: always

.unit_test_template_x86_64:
  extends: .unit_test_template
  needs:
    - "build_x86_64-released"
    - "build_x86_64-exp-dev-extra"
  variables:
    ARCH: "x86_64"

.tezt_template:
  variables:
    JUNIT: "tezt-junit.xml"
    # if we do not set BISECT_FILE here, it will be empty, and include the 
    # full CI_PROJECT_DIR in artifacts as per the template .tezt_template.
    BISECT_FILE: "$CI_PROJECT_DIR/_coverage_output/"
  artifacts:
    reports:
      junit: $JUNIT
    paths:
      - tezt.log
      - tezt-*.log
      - tezt-results-$CI_NODE_INDEX.json
      - $BISECT_FILE
      - $JUNIT
    # These record artifacts (tezt-results-$CI_NODE_INDEX.json) should
    # be stored for as long as a given commit on master is expected to
    # be HEAD in order to support auto-balancing. At the time of
    # writing, we have approximately 6 merges per day, so 1 day should
    # more than enough. The tezt artifacts (including records and
    # coverage) take up roughly 1MB.
    expire_in: 1 day
    # certain tests can be blacklisted by adding it to this variable
    when: always
  script:
    - make -C ${CI_PROJECT_DIR}/.gitlab/ci test-tezt
