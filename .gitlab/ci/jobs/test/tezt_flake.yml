include: .gitlab/ci/jobs/test/common.yml

# We use the --job option to split tests into jobs of roughly the same
# duration. This is based on a file that contains timings of test results,
# generated with --record. To rebalance jobs, update this record with:
#
#   make && dune exec tezt/tests/main.exe -- --record tezt/test-results.json

tezt:
  extends:
    - .integration_template
    - .template__coverage_files
    - .tezt_template
  variables:
    JUNIT: "tezt-junit.xml"
  artifacts:
    reports:
      junit: $JUNIT
    paths:
      - tezt.log
      - tezt-results-$CI_NODE_INDEX.json
      - $JUNIT
    expire_in: 1 hour
    when: always
  script:
    - echo "Running flakiness test for targets TZ_FLAKE_TEST_TESTS=${TZ_FLAKE_TEST_TESTS}, TZ_FLAKE_TEST_LOOP_COUNT=${TZ_FLAKE_TEST_LOOP_COUNT:-1}"
    - make -C ${CI_PROJECT_DIR}/.gitlab/ci test-tezt-flake
  dependencies:
    - "build_x86_64-released"
    - "build_x86_64-exp-dev-extra"
    - "build_kernels"
  needs:
    - "build_x86_64-released"
    - "build_x86_64-exp-dev-extra"
    - "build_kernels"
  # Unfortunately, the number of jobs running in parallel in the flake
  # tests pipeline cannot be set dynamically through a pipeline
  # variable.
  parallel: 20
  retry: 0
