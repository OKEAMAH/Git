# This file was automatically generated, do not edit.
# Edit file ci/bin/main.ml instead.

tezt_flaky:
  image: ${build_deps_image_name}:runtime-e2etest-dependencies--${build_deps_image_version}
  stage: test
  tags:
  - gcp_tezt
  needs:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  dependencies:
  - oc.build_x86_64-released
  - oc.build_x86_64-exp-dev-extra
  - oc.build_kernels
  - oc.tezt:fetch-records
  script:
  - echo "TESTS=\"${TESTS}\" JUNIT=\"${JUNIT}\" CI_NODE_INDEX=\"${CI_NODE_INDEX}\"
    CI_NODE_TOTAL=\"${CI_NODE_TOTAL}\" TEZT_PARALLEL=\"${TEZT_PARALLEL}\" TEZT_VARIANT=\"${TEZT_VARIANT}\""
  - ./scripts/ci/exit_code.sh timeout -k 60 1860 ./scripts/ci/exit_code.sh _build/default/tezt/tests/main.exe
    ${TESTS} --color --log-buffer-size 5000 --log-file tezt.log --global-timeout 1800
    --on-unknown-regression-files fail --junit ${JUNIT} --from-record tezt/records
    --job ${CI_NODE_INDEX:-1}/${CI_NODE_TOTAL:-1} --record tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    --job-count ${TEZT_PARALLEL:-3} --retry ${TEZT_RETRY:-1}
  - ./scripts/ci/merge_coverage.sh
  before_script:
  - . ./scripts/version.sh
  - eval $(opam env)
  variables:
    JUNIT: tezt-junit.xml
    TEZT_VARIANT: ""
    TESTS: flaky
    TEZT_RETRY: "3"
    TEZT_PARALLEL: "1"
    COVERAGE_OPTIONS: --instrument-with bisect_ppx
    BISECT_FILE: $CI_PROJECT_DIR/_coverage_output/
    SLACK_COVERAGE_CHANNEL: C02PHBE7W73
  artifacts:
    name: coverage-files-$CI_JOB_ID
    expire_in: 3 days
    paths:
    - tezt.log
    - tezt-*.log
    - tezt-results-${CI_NODE_INDEX}${TEZT_VARIANT}.json
    - $BISECT_FILE
    - $JUNIT
    reports:
      junit: $JUNIT
    when: always
  retry: 2
  parallel: 1
